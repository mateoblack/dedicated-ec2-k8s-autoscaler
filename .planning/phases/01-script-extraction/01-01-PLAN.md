---
phase: 01-script-extraction
plan: 01
type: execute
---

<objective>
Extract the 3 Lambda code generation methods from compute-stack.ts into separate TypeScript modules under lib/scripts/.

Purpose: Reduce compute-stack.ts size by ~1,070 lines while maintaining the inline Lambda pattern required by CDK. Enable isolated testing of Lambda code logic in Phase 6.
Output: Three new TypeScript files exporting Lambda code generation functions.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/compute-stack.ts

**Constraints from PROJECT.md:**
- Lambda code must remain inline strings (CDK deployment pattern)
- All 30 existing tests must pass after refactor
- Behavior must remain identical (pure refactor)

**Method locations in compute-stack.ts:**
- `createEtcdLifecycleLambdaCode`: lines 362-942 (581 lines)
- `createEtcdBackupLambdaCode`: lines 1348-1582 (235 lines)
- `createClusterHealthLambdaCode`: lines 1584-1837 (254 lines)

**Pattern to follow:**
Each extracted file should export a function matching the original private method signature:
```typescript
export function createXxxLambdaCode(param1: type1, param2?: type2): string {
  return `...`;
}
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lib/scripts/ directory and extract etcd-lifecycle Lambda</name>
  <files>lib/scripts/etcd-lifecycle-lambda.ts</files>
  <action>
1. Create `lib/scripts/` directory
2. Create `lib/scripts/etcd-lifecycle-lambda.ts`
3. Copy the entire `createEtcdLifecycleLambdaCode` method body from compute-stack.ts (lines 362-942)
4. Export as a named function with same signature: `export function createEtcdLifecycleLambdaCode(clusterName: string): string`
5. The function returns the template literal containing the Python Lambda code

DO NOT modify the Python code content - this is a pure extraction.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit lib/scripts/etcd-lifecycle-lambda.ts`</verify>
  <done>File exists, exports function, compiles without errors</done>
</task>

<task type="auto">
  <name>Task 2: Extract etcd-backup and cluster-health Lambda code</name>
  <files>lib/scripts/etcd-backup-lambda.ts, lib/scripts/cluster-health-lambda.ts</files>
  <action>
1. Create `lib/scripts/etcd-backup-lambda.ts`
   - Copy `createEtcdBackupLambdaCode` method body from compute-stack.ts (lines 1348-1582)
   - Export as: `export function createEtcdBackupLambdaCode(clusterName: string, backupBucket: string): string`

2. Create `lib/scripts/cluster-health-lambda.ts`
   - Copy `createClusterHealthLambdaCode` method body from compute-stack.ts (lines 1584-1837)
   - Export as: `export function createClusterHealthLambdaCode(clusterName: string, backupBucket: string): string`

DO NOT modify the Python code content - this is a pure extraction.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit lib/scripts/etcd-backup-lambda.ts lib/scripts/cluster-health-lambda.ts`</verify>
  <done>Both files exist, export correct functions, compile without errors</done>
</task>

<task type="auto">
  <name>Task 3: Create barrel file for scripts module</name>
  <files>lib/scripts/index.ts</files>
  <action>
Create `lib/scripts/index.ts` that re-exports all Lambda code functions:

```typescript
export { createEtcdLifecycleLambdaCode } from './etcd-lifecycle-lambda';
export { createEtcdBackupLambdaCode } from './etcd-backup-lambda';
export { createClusterHealthLambdaCode } from './cluster-health-lambda';
```

This enables clean imports in compute-stack.ts: `import { createEtcdLifecycleLambdaCode } from './scripts';`
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit lib/scripts/index.ts`</verify>
  <done>Barrel file exists and re-exports all three Lambda functions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `lib/scripts/` directory exists with 4 files (3 lambdas + index.ts)
- [ ] `npx tsc --noEmit` passes for all new files
- [ ] Each Lambda file exports function with correct signature
- [ ] Barrel file re-exports all Lambda functions
</verification>

<success_criteria>

- All 3 Lambda code files created under lib/scripts/
- Barrel file (index.ts) exports all functions
- TypeScript compilation succeeds
- No modifications to compute-stack.ts yet (that's Plan 03)
</success_criteria>

<output>
After completion, create `.planning/phases/01-script-extraction/01-01-SUMMARY.md`
</output>
