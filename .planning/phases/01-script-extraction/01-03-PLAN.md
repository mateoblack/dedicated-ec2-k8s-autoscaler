---
phase: 01-script-extraction
plan: 03
type: execute
---

<objective>
Update compute-stack.ts to import extracted functions and remove the private methods, completing the refactor.

Purpose: Complete the script extraction by wiring up the new modules. Verify all 30 tests pass.
Output: Reduced compute-stack.ts (~366 lines vs original 3,623 lines), passing test suite.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-script-extraction/01-01-SUMMARY.md
@.planning/phases/01-script-extraction/01-02-SUMMARY.md
@lib/compute-stack.ts
@lib/scripts/index.ts

**Constraints from PROJECT.md:**
- All 30 existing tests must pass after refactor
- Behavior must remain identical

**Current state after Plans 01-02:**
- 5 script generator functions extracted to lib/scripts/
- compute-stack.ts still has the original private methods

**Call sites in compute-stack.ts:**
- Line 83: `this.createControlPlaneBootstrapScript(props.clusterName, props.oidcProviderArn, props.oidcBucketName, props.etcdBackupBucketName)`
- Line 119: `this.createEtcdLifecycleLambdaCode(props.clusterName)`
- Line 190: `this.createEtcdBackupLambdaCode(props.clusterName, props.etcdBackupBucketName)`
- Line 255: `this.createClusterHealthLambdaCode(props.clusterName, props.etcdBackupBucketName)`
- Line 337: `this.createWorkerBootstrapScript(props.clusterName)`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add import and update call sites in compute-stack.ts</name>
  <files>lib/compute-stack.ts</files>
  <action>
1. Add import at top of file (after other imports, before interface):
```typescript
import {
  createEtcdLifecycleLambdaCode,
  createEtcdBackupLambdaCode,
  createClusterHealthLambdaCode,
  createWorkerBootstrapScript,
  createControlPlaneBootstrapScript
} from './scripts';
```

2. Update all 5 call sites to remove `this.` prefix:
- Line 83: Change `this.createControlPlaneBootstrapScript(...)` to `createControlPlaneBootstrapScript(...)`
- Line 119: Change `this.createEtcdLifecycleLambdaCode(...)` to `createEtcdLifecycleLambdaCode(...)`
- Line 190: Change `this.createEtcdBackupLambdaCode(...)` to `createEtcdBackupLambdaCode(...)`
- Line 255: Change `this.createClusterHealthLambdaCode(...)` to `createClusterHealthLambdaCode(...)`
- Line 337: Change `this.createWorkerBootstrapScript(...)` to `createWorkerBootstrapScript(...)`

DO NOT delete the private methods yet - verify compilation first.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit lib/compute-stack.ts`</verify>
  <done>Import added, all 5 call sites updated, compiles without errors</done>
</task>

<task type="auto">
  <name>Task 2: Remove private methods from compute-stack.ts</name>
  <files>lib/compute-stack.ts</files>
  <action>
Delete the 5 private methods from compute-stack.ts:
1. Delete `private createEtcdLifecycleLambdaCode` (lines 362-942)
2. Delete `private createWorkerBootstrapScript` (lines 944-1346)
3. Delete `private createEtcdBackupLambdaCode` (lines 1348-1582)
4. Delete `private createClusterHealthLambdaCode` (lines 1584-1837)
5. Delete `private createControlPlaneBootstrapScript` (lines 1839-3622)

After deletion, compute-stack.ts should be approximately 360-400 lines.

IMPORTANT: Delete in reverse order (bottom to top) to preserve line numbers during deletion.
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit lib/compute-stack.ts`
2. File size check: `wc -l lib/compute-stack.ts` should show ~360-400 lines
  </verify>
  <done>All 5 private methods removed, file reduced to ~360-400 lines, compiles without errors</done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite to verify refactor</name>
  <files>None (verification only)</files>
  <action>
Run the full test suite to ensure the refactor preserves behavior:

```bash
npm test
```

All 30 test files should pass. If any test fails:
1. Check that the extracted function signature matches the original
2. Verify the template literal content was copied exactly
3. Ensure all call sites use correct parameters
  </action>
  <verify>`npm test` exits with code 0, all tests pass</verify>
  <done>All 30 test files pass, 0 failures</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx tsc --noEmit` passes for entire project
- [ ] `npm test` passes all 30 test files
- [ ] `wc -l lib/compute-stack.ts` shows ~360-400 lines (down from 3,623)
- [ ] `lib/scripts/` contains 6 files with ~3,257 lines total
</verification>

<success_criteria>

- compute-stack.ts reduced from 3,623 lines to ~360-400 lines
- All 5 script generation functions imported from lib/scripts/
- All 30 existing tests pass
- Phase 1 complete, ready for Phase 2
</success_criteria>

<output>
After completion, create `.planning/phases/01-script-extraction/01-03-SUMMARY.md`
</output>
