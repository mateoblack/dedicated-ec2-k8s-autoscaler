---
phase: 02-retry-consolidation
plan: 01
type: execute
---

<objective>
Create shared Bash retry functions module and update bootstrap scripts to use it.

Purpose: Consolidate duplicated retry logic (retry_command, retry_command_output) from control-plane and worker bootstrap scripts into a single source of truth.
Output: Shared bash-retry.ts module, updated bootstrap scripts importing shared functions.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 1 summaries (dependency graph)
@.planning/phases/01-script-extraction/01-02-SUMMARY.md
@.planning/phases/01-script-extraction/01-03-SUMMARY.md

# Source files to modify
@lib/scripts/index.ts
@lib/scripts/control-plane-bootstrap.ts
@lib/scripts/worker-bootstrap.ts

**Established patterns from Phase 1:**
- Script functions return template strings with interpolated config values
- Barrel file (index.ts) exports all script generators
- Pass stack parameter for region access

**Retry functions to consolidate (currently duplicated):**
- `retry_command()` - in control-plane-bootstrap.ts only (lines 140-163)
- `retry_command_output()` - in both scripts (control-plane lines 167-189, worker lines 60-82)
- Both use `eval "$cmd"` which will be addressed in Phase 5

**Tech context:**
- TypeScript functions generating bash script strings
- String interpolation with `${variable}` for config injection
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared bash retry functions module</name>
  <files>lib/scripts/bash-retry.ts</files>
  <action>Create new TypeScript file that exports `getBashRetryFunctions(): string`. The function returns a bash script string containing:

1. Comment header explaining usage
2. Constants: `MAX_RETRIES` and `RETRY_DELAY` (these will be overridable by scripts that include before this)
3. `retry_command()` function - exact copy from control-plane-bootstrap.ts lines 140-163
4. `retry_command_output()` function - exact copy from control-plane-bootstrap.ts lines 167-189

Use the exact same implementation to preserve behavior. Add JSDoc comment explaining this is a shared module.

Note: The `eval` usage remains unchanged - Phase 5 will address this as a separate concern.</action>
  <verify>npx tsc --noEmit passes, file exists with exported function</verify>
  <done>lib/scripts/bash-retry.ts exists with getBashRetryFunctions export, compiles without errors</done>
</task>

<task type="auto">
  <name>Task 2: Update control-plane-bootstrap.ts to use shared module</name>
  <files>lib/scripts/control-plane-bootstrap.ts</files>
  <action>1. Add import: `import { getBashRetryFunctions } from './bash-retry';`

2. In createControlPlaneBootstrapScript function, after the initial constants (MAX_RETRIES, RETRY_DELAY on lines 35-36), insert the shared functions:
   - Replace lines 137-189 (retry_command and retry_command_output functions) with: `${getBashRetryFunctions()}`

3. Keep the script's own MAX_RETRIES and RETRY_DELAY constants - these MUST come before the shared functions so bash uses the script's values

The result should have:
- Script constants at top (MAX_RETRIES=5, RETRY_DELAY=5)
- Shared retry functions interpolated in
- All call sites unchanged (they already call retry_command and retry_command_output)</action>
  <verify>npx tsc --noEmit passes, grep confirms no duplicate retry function definitions in file</verify>
  <done>control-plane-bootstrap.ts imports shared module, retry functions replaced with interpolation, compiles</done>
</task>

<task type="auto">
  <name>Task 3: Update worker-bootstrap.ts to use shared module</name>
  <files>lib/scripts/worker-bootstrap.ts</files>
  <action>1. Add import: `import { getBashRetryFunctions } from './bash-retry';`

2. In createWorkerBootstrapScript function, replace the retry_command_output function (lines 59-82) with interpolation: `${getBashRetryFunctions()}`

3. This gives worker-bootstrap both retry_command AND retry_command_output (consistency with control-plane), though it only uses retry_command_output currently

4. Ensure MAX_RETRIES and RETRY_DELAY constants remain before the interpolation point

5. Run tests to verify no behavior change</action>
  <verify>npm test -- --testPathPattern="worker|bootstrap" passes, grep confirms no duplicate retry function definitions</verify>
  <done>worker-bootstrap.ts imports shared module, retry function replaced with interpolation, all tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes (no type errors)
- [ ] `npm test` passes all 30 test suites
- [ ] `grep -c "retry_command()" lib/scripts/bash-retry.ts` returns 1 (defined once in shared module)
- [ ] `grep -c "retry_command\(\)" lib/scripts/control-plane-bootstrap.ts` returns 0 (no local definition)
- [ ] `grep -c "retry_command_output\(\)" lib/scripts/worker-bootstrap.ts` returns 0 (no local definition)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Bash retry logic exists in exactly one location (bash-retry.ts)
- Both bootstrap scripts use the shared module via interpolation
- No test failures or TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-retry-consolidation/02-01-SUMMARY.md`:

# Phase 2 Plan 01: Bash Retry Module Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `lib/scripts/bash-retry.ts` - Created shared bash retry functions module
- `lib/scripts/control-plane-bootstrap.ts` - Updated to use shared module
- `lib/scripts/worker-bootstrap.ts` - Updated to use shared module

## Decisions Made

[Any decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

[Ready for 02-02-PLAN.md]
</output>
