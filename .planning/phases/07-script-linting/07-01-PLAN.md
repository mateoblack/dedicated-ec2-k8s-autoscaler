---
phase: 07-script-linting
plan: 01
type: execute
---

<objective>
Integrate shellcheck into the test pipeline to lint embedded bash scripts.

Purpose: Catch shell scripting bugs, undefined variables, quoting issues, and other common errors in the bootstrap scripts at test time rather than runtime.
Output: Passing shellcheck tests and clean bash scripts with no shellcheck warnings.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-lambda-unit-tests/06-01-SUMMARY.md

# Relevant source files
@lib/scripts/bash-retry.ts
@lib/scripts/control-plane-bootstrap.ts
@lib/scripts/worker-bootstrap.ts
@package.json

**Tech stack available:**
- Jest 29.5.0 (testing framework)
- TypeScript 4.9.5
- lib/scripts/*.ts modules export functions returning bash script strings

**Established patterns:**
- Tests in /test/ directory with *.test.ts naming
- npm run test:code runs jest directly
- Bootstrap generators export functions that return bash strings

**Constraining decisions:**
- Phase 1: Scripts extracted to lib/scripts/ (bootstrap code is in TypeScript files returning bash strings)
- Bash scripts use $* for echo display, "$@" for execution (Phase 5 decision)
- Scripts embed Python code for AWS API calls

**Key insight from discovery:**
The `shellcheck` npm package provides a programmatic API. Write a Jest test that:
1. Imports the bootstrap generator functions
2. Generates the bash scripts to temp files
3. Runs shellcheck on each temp file
4. Reports errors as Jest test failures

This approach:
- Works with existing Jest test infrastructure
- No custom CLI scripts needed
- Tests run automatically with npm run test:code
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shellcheck npm package and create linting test</name>
  <files>package.json, test/shellcheck-linting.test.ts</files>
  <action>
1. Install shellcheck as dev dependency: npm install --save-dev shellcheck

2. Create test/shellcheck-linting.test.ts with:
   - Import shellcheck from 'shellcheck' package
   - Import bootstrap generator functions from lib/scripts/
   - Create mock cdk.Stack with region property for function calls
   - For each bootstrap script generator:
     a. Call function to get bash script string
     b. Write to temp file
     c. Run shellcheck with JSON output format
     d. Parse results and fail test if any issues found
   - Also test getBashRetryFunctions() output

3. Test structure:
   ```typescript
   describe('Shell Script Linting', () => {
     describe('control-plane-bootstrap', () => {
       test('passes shellcheck', async () => { ... });
     });
     describe('worker-bootstrap', () => {
       test('passes shellcheck', async () => { ... });
     });
     describe('bash-retry', () => {
       test('passes shellcheck', async () => { ... });
     });
   });
   ```

4. Use shellcheck options:
   - --shell=bash (explicit shell type)
   - --format=json (for programmatic parsing)
   - --exclude=SC1091 (file not found for sourced files - we don't source external files)
   - --exclude=SC2034 (unused variables - some vars are used by embedded Python)
   - --exclude=SC2154 (referenced but not assigned - some vars come from CDK interpolation like ${clusterName})

5. Helper function to run shellcheck:
   ```typescript
   async function runShellcheck(script: string, name: string): Promise<void> {
     const tmpFile = path.join(os.tmpdir(), `${name}-${Date.now()}.sh`);
     try {
       fs.writeFileSync(tmpFile, script);
       const result = await shellcheck({
         args: ['--shell=bash', '--format=json', '--exclude=SC1091,SC2034,SC2154', tmpFile]
       });
       // Parse JSON output and report issues
     } finally {
       fs.unlinkSync(tmpFile);
     }
   }
   ```
  </action>
  <verify>npm run test:code -- test/shellcheck-linting.test.ts runs (may fail if scripts have issues)</verify>
  <done>Shellcheck test file exists and runs, package.json has shellcheck dependency</done>
</task>

<task type="auto">
  <name>Task 2: Fix any shellcheck warnings in bash scripts</name>
  <files>lib/scripts/bash-retry.ts, lib/scripts/control-plane-bootstrap.ts, lib/scripts/worker-bootstrap.ts</files>
  <action>
Run the shellcheck test from Task 1 and fix any legitimate issues reported.

Common shellcheck fixes to apply:
- SC2086: Double quote to prevent globbing and word splitting
- SC2155: Declare and assign separately to avoid masking return values
- SC2181: Check exit code directly with `if cmd; then` instead of `if [ $? -eq 0 ]`
- SC2004: $/${} is unnecessary on arithmetic variables
- SC2166: Prefer [ p ] && [ q ] over [ p -a q ]

DO NOT fix issues that are:
- False positives from CDK string interpolation (${clusterName}, ${region})
- Related to embedded Python code sections
- Unused variables that are actually used by embedded Python or later script sections

For each fix:
1. Understand why shellcheck flagged it
2. Verify the fix doesn't change script behavior
3. Apply minimal fix to resolve the issue

If many issues exist, prioritize:
1. Quoting issues (security/correctness impact)
2. Error handling issues
3. Style issues (lowest priority)
  </action>
  <verify>npm run test:code -- test/shellcheck-linting.test.ts passes with no failures</verify>
  <done>All shellcheck tests pass, scripts have no warnings (or only intentionally excluded ones)</done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite and add npm script</name>
  <files>package.json</files>
  <action>
1. Run full test suite: npm run test:code
   - Verify all existing tests still pass
   - Verify new shellcheck tests pass

2. Add dedicated lint:shell script to package.json:
   ```json
   "scripts": {
     "lint:shell": "jest test/shellcheck-linting.test.ts"
   }
   ```
   This allows running shell linting independently.

3. Verify: npm run lint:shell works correctly
  </action>
  <verify>npm run test:code passes all tests including shellcheck, npm run lint:shell works</verify>
  <done>Full test suite passes, lint:shell script added and working</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:code` passes all tests
- [ ] `npm run lint:shell` runs shellcheck tests successfully
- [ ] No shellcheck errors in control-plane-bootstrap
- [ ] No shellcheck errors in worker-bootstrap
- [ ] No shellcheck errors in bash-retry
- [ ] package.json has shellcheck dependency and lint:shell script
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Shellcheck integrated into test pipeline
- Bash scripts are clean with no legitimate warnings
- Full test suite passes (should be 32+ test suites after adding shellcheck-linting.test.ts)
</success_criteria>

<output>
After completion, create `.planning/phases/07-script-linting/07-01-SUMMARY.md`
</output>
