---
phase: 09-structured-logging
plan: 04
type: execute
---

<objective>
Migrate Lambda functions from plain text logging to structured JSON logging.

Purpose: Enable CloudWatch Logs Insights queries and consistent log format across all Lambda operations.
Output: Updated etcd-lifecycle-lambda.ts, etcd-backup-lambda.ts, and cluster-health-lambda.ts using getPythonLoggingSetup().
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-structured-logging/09-03-SUMMARY.md

**Prior plan provides:**
- getPythonLoggingSetup() from lib/scripts/python-logging.ts
- JsonFormatter class and setup_logging() function

**Files to modify:**
@lib/scripts/etcd-lifecycle-lambda.ts
@lib/scripts/etcd-backup-lambda.ts
@lib/scripts/cluster-health-lambda.ts

**Current state:**
- 67 logger calls across the three files
- Uses standard `logger = logging.getLogger()` and `logger.setLevel(logging.INFO)`
- Uses f-string formatting: `logger.info(f"message: {var}")`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update etcd-lifecycle-lambda.ts</name>
  <files>lib/scripts/etcd-lifecycle-lambda.ts</files>
  <action>
1. Add import: `import { getPythonLoggingSetup } from './python-logging';`

2. Replace the existing logger setup:
   ```python
   logger = logging.getLogger()
   logger.setLevel(logging.INFO)
   ```

   With the interpolated logging setup:
   ```python
   ${getPythonLoggingSetup()}
   ```

3. Add at the START of the handler function:
   ```python
   logger = setup_logging(context)
   ```

4. Update logger calls to include structured context where valuable:
   - `logger.info(f"Processing termination for instance: {instance_id}")`
     â†’ `logger.info("Processing instance termination", extra={'instance_id': instance_id})`
   - Keep simple messages as-is: `logger.info("etcd is healthy")` (no change needed)
   - Error logs should include relevant context:
     `logger.error(f"Failed: {str(e)}", extra={'error_type': type(e).__name__})`

5. For the `exc_info=True` pattern, keep it:
   `logger.error(f"Unexpected error: {str(e)}", exc_info=True)` stays as-is (exc_info works with JSON formatter)

Do NOT change logic, just logging format.
  </action>
  <verify>`npm run build` succeeds, `npm run test:code` passes</verify>
  <done>etcd-lifecycle-lambda.ts uses JSON structured logging with context</done>
</task>

<task type="auto">
  <name>Task 2: Update etcd-backup-lambda.ts</name>
  <files>lib/scripts/etcd-backup-lambda.ts</files>
  <action>
1. Add import: `import { getPythonLoggingSetup } from './python-logging';`

2. Replace existing logger setup with interpolated setup

3. Add `logger = setup_logging(context)` at handler start

4. Update logger calls with structured context where valuable:
   - Backup operations should include bucket, key context
   - SSM commands should include instance_id, command_id

Follow same patterns as etcd-lifecycle-lambda.ts.
  </action>
  <verify>`npm run build` succeeds, `npm run test:code` passes</verify>
  <done>etcd-backup-lambda.ts uses JSON structured logging with context</done>
</task>

<task type="auto">
  <name>Task 3: Update cluster-health-lambda.ts</name>
  <files>lib/scripts/cluster-health-lambda.ts</files>
  <action>
1. Add import: `import { getPythonLoggingSetup } from './python-logging';`

2. Replace existing logger setup with interpolated setup

3. Add `logger = setup_logging(context)` at handler start

4. Update logger calls with structured context where valuable:
   - Health check results should include component, status
   - Instance checks should include instance_id

Follow same patterns as other Lambda files.
  </action>
  <verify>`npm run build` succeeds, `npm run test:code` passes</verify>
  <done>cluster-health-lambda.ts uses JSON structured logging with context</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run test:code` passes all tests
- [ ] All three Lambda files import and use getPythonLoggingSetup()
- [ ] Handler functions call setup_logging(context) at start
- [ ] Logger calls include extra context where appropriate
</verification>

<success_criteria>

- All three Lambda code generators use JSON structured logging
- Each handler initializes logging with setup_logging(context)
- Logger calls include relevant context via extra parameter
- All existing tests continue to pass
- Phase 9 complete
</success_criteria>

<output>
After completion, create `.planning/phases/09-structured-logging/09-04-SUMMARY.md`
</output>
