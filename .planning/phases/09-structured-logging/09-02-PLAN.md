---
phase: 09-structured-logging
plan: 02
type: execute
---

<objective>
Migrate bootstrap scripts from plain echo to structured JSON logging.

Purpose: Enable CloudWatch Logs Insights queries and consistent log format across all bootstrap operations.
Output: Updated control-plane-bootstrap.ts and worker-bootstrap.ts using getBashLoggingFunctions().
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-structured-logging/09-01-SUMMARY.md

**Prior plan provides:**
- getBashLoggingFunctions() from lib/scripts/bash-logging.ts
- log_info, log_warn, log_error, log_debug functions available after interpolation

**Files to modify:**
@lib/scripts/control-plane-bootstrap.ts
@lib/scripts/worker-bootstrap.ts

**Current state:**
- ~23 echo statements across both files
- Includes status messages, errors, and stage transitions
- Some echoes include variable interpolation (e.g., `echo "Instance ID: $INSTANCE_ID"`)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update control-plane-bootstrap.ts logging</name>
  <files>lib/scripts/control-plane-bootstrap.ts</files>
  <action>
1. Add import: `import { getBashLoggingFunctions } from './bash-logging';`

2. Add interpolation after the retry functions interpolation:
   ```
   ${getBashLoggingFunctions()}
   ```

3. Replace echo statements with appropriate log functions:
   - `echo "Starting control plane bootstrap..."` → `log_info "Starting control plane bootstrap" "cluster=${clusterName}"`
   - `echo "ERROR: ..."` → `log_error "..."`
   - `echo "Warning: ..."` → `log_warn "..."`
   - Stage transitions: `log_info "Stage transition" "from=init" "to=kubeadm-init"`

4. Keep BOOTSTRAP_STAGE variable updates but also log them:
   ```bash
   BOOTSTRAP_STAGE="kubeadm-init"
   log_info "Bootstrap stage: kubeadm-init"
   ```

5. For variable interpolation echoes, use context params:
   - `echo "Instance ID: $INSTANCE_ID"` → `log_info "Instance metadata retrieved" "instance_id=$INSTANCE_ID" "private_ip=$PRIVATE_IP"`

Do NOT change:
- Logic or control flow
- Error handling behavior
- The cleanup_on_failure function's echo statements (these can stay as echo for debugging, or convert if appropriate)
  </action>
  <verify>`npm run build` succeeds, `npm run test:code` passes</verify>
  <done>All informational echo statements replaced with structured log calls</done>
</task>

<task type="auto">
  <name>Task 2: Update worker-bootstrap.ts logging</name>
  <files>lib/scripts/worker-bootstrap.ts</files>
  <action>
1. Add import: `import { getBashLoggingFunctions } from './bash-logging';`

2. Add interpolation after the retry functions interpolation:
   ```
   ${getBashLoggingFunctions()}
   ```

3. Replace echo statements with appropriate log functions following same patterns as control-plane.

4. Worker-specific context should include "node_type=worker" in initial log.

Do NOT change logic or control flow.
  </action>
  <verify>`npm run build` succeeds, `npm run test:code` passes</verify>
  <done>All informational echo statements replaced with structured log calls</done>
</task>

<task type="auto">
  <name>Task 3: Update bash-retry.ts to use structured logging</name>
  <files>lib/scripts/bash-retry.ts</files>
  <action>
Update the retry functions in bash-retry.ts to use structured logging if available.

The retry functions currently do:
- `echo "Executing (attempt $attempt/$MAX_RETRIES): $*"`
- `echo "Command failed, retrying in ${delay}s..."`
- `echo "ERROR: Command failed after $MAX_RETRIES attempts: $*"`

Replace with conditional logging that checks if log_info exists (for backwards compatibility if the logging module isn't included):
```bash
if command -v log_info >/dev/null 2>&1; then
    log_info "Executing command" "attempt=$attempt" "max_retries=$MAX_RETRIES" "command=$*"
else
    echo "Executing (attempt $attempt/$MAX_RETRIES): $*"
fi
```

This ensures the retry module works both with and without the logging module (though in practice, both will always be included together now).
  </action>
  <verify>`npm run build` succeeds, `npm run test:code` passes</verify>
  <done>Retry functions use structured logging with fallback to echo</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run test:code` passes all tests
- [ ] Manual review: control-plane-bootstrap.ts uses log_info/log_warn/log_error
- [ ] Manual review: worker-bootstrap.ts uses log_info/log_warn/log_error
- [ ] Manual review: bash-retry.ts uses structured logging with fallback
</verification>

<success_criteria>

- Both bootstrap scripts import and use getBashLoggingFunctions()
- Plain echo statements replaced with structured log_* calls
- bash-retry.ts updated with conditional structured logging
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-structured-logging/09-02-SUMMARY.md`
</output>
