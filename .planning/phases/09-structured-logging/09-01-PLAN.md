---
phase: 09-structured-logging
plan: 01
type: execute
---

<objective>
Create shared bash structured logging module for JSON log output in bootstrap scripts.

Purpose: Establish consistent JSON logging format for bash scripts, enabling CloudWatch Logs Insights queries and structured monitoring.
Output: New `lib/scripts/bash-logging.ts` module with JSON logging functions that can be interpolated into bootstrap scripts.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/scripts/bash-retry.ts
@lib/scripts/index.ts

**Established patterns from prior phases:**
- Shared bash module pattern: TypeScript function returning bash script string
- getBashRetryFunctions() exported from bash-retry.ts, interpolated via ${getBashRetryFunctions()}
- Scripts define constants (MAX_RETRIES, etc.) before interpolation point

**Current logging:**
- Bootstrap scripts use plain `echo` statements
- No structured format, no severity levels, no timestamps
- CloudWatch Logs Insights queries are difficult without structure
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bash-logging.ts module</name>
  <files>lib/scripts/bash-logging.ts</files>
  <action>
Create new module with getBashLoggingFunctions() that returns bash functions for structured JSON logging.

Functions to include:
- `log_json()`: Core function that outputs JSON with timestamp, level, message, and optional context fields
- `log_info()`: INFO level convenience wrapper
- `log_warn()`: WARN level convenience wrapper
- `log_error()`: ERROR level convenience wrapper
- `log_debug()`: DEBUG level convenience wrapper (respects LOG_LEVEL variable)

JSON format:
```json
{"timestamp":"ISO8601","level":"INFO","message":"text","instance_id":"i-xxx","stage":"bootstrap-stage"}
```

Requirements:
- Use `date -u +%Y-%m-%dT%H:%M:%SZ` for ISO8601 timestamps
- Include INSTANCE_ID and BOOTSTRAP_STAGE from script environment automatically
- Support optional key=value pairs for additional context: `log_info "message" "key1=val1" "key2=val2"`
- Properly escape JSON strings (handle quotes, newlines, backslashes)
- Keep bash-compatible (no bashisms that break POSIX sh if possible, but bash is acceptable since we use #!/bin/bash)
  </action>
  <verify>TypeScript compiles: `npm run build`</verify>
  <done>bash-logging.ts exports getBashLoggingFunctions() and compiles without errors</done>
</task>

<task type="auto">
  <name>Task 2: Export from scripts module and add unit test</name>
  <files>lib/scripts/index.ts, test/scripts/bash-logging.test.ts</files>
  <action>
1. Add export for getBashLoggingFunctions to lib/scripts/index.ts (follow existing pattern from bash-retry)

2. Create test file that verifies:
   - Function returns non-empty string
   - Output contains all expected function definitions (log_json, log_info, log_warn, log_error, log_debug)
   - JSON output is valid (test actual bash execution if possible, otherwise test string contains expected patterns)
   - Escaping works correctly for quotes and special characters

Follow test patterns from existing bash-retry tests if any exist, otherwise follow Jest patterns in test/ directory.
  </action>
  <verify>`npm run test:code -- --testPathPattern=bash-logging`</verify>
  <done>Tests pass, module is exported and usable</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] `npm run test:code -- --testPathPattern=bash-logging` passes
- [ ] getBashLoggingFunctions() is exported from lib/scripts/index.ts
- [ ] Manual inspection: output contains valid JSON logging functions
</verification>

<success_criteria>

- bash-logging.ts module created with JSON logging functions
- Functions properly escape JSON and include timestamp, level, instance context
- Module exported from lib/scripts/index.ts
- Unit tests verify function definitions and output format
</success_criteria>

<output>
After completion, create `.planning/phases/09-structured-logging/09-01-SUMMARY.md`
</output>
