---
phase: 05-eval-removal
plan: 01
type: execute
---

<objective>
Replace eval usage in bash retry functions with safer "$@" command execution pattern.

Purpose: Eliminate command injection risk from eval by using positional parameters for command execution
Output: Modified retry functions using "$@" pattern, updated callers, passing tests
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context (Phase 2 established retry module)
@.planning/phases/02-retry-consolidation/02-01-SUMMARY.md

# Key files
@lib/scripts/bash-retry.ts
@lib/scripts/control-plane-bootstrap.ts
@lib/scripts/worker-bootstrap.ts

**Tech stack available:** CDK, TypeScript, Bash bootstrap scripts
**Established patterns:** Shared bash module pattern, template string interpolation

**Constraining decisions:**
- Phase 02-01: Both retry functions included in shared module for consistency
- Phase 02-01: Constants remain in individual scripts before interpolation

**Current eval usage (2 locations in bash-retry.ts):**
- Line 43: `if eval "$cmd"; then` in retry_command()
- Line 69: `output=$(eval "$cmd" 2>/dev/null)` in retry_command_output()

**Why eval is risky:**
The retry functions receive commands as strings and use `eval` to execute them.
While the current callers pass static command strings, `eval` enables shell
interpretation which could execute arbitrary code if the string contains
metacharacters or is user-influenced.

**The safer pattern:**
Replace `eval "$cmd"` with `"$@"` which executes arguments directly without
shell interpretation. This requires changing caller syntax from:
  `retry_command "aws ssm get-parameter --name 'foo'"`
to:
  `retry_command aws ssm get-parameter --name 'foo'`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update bash-retry.ts retry functions to use "$@" pattern</name>
  <files>lib/scripts/bash-retry.ts</files>
  <action>
Modify retry_command() and retry_command_output() to use "$@" instead of eval:

1. In retry_command():
   - Remove `local cmd="$1"`
   - Change `echo "Executing (attempt $attempt/$MAX_RETRIES): $cmd"` to `echo "Executing (attempt $attempt/$MAX_RETRIES): $*"`
   - Change `if eval "$cmd"; then` to `if "$@"; then`
   - Change `echo "ERROR: Command failed after $MAX_RETRIES attempts: $cmd"` to `echo "ERROR: Command failed after $MAX_RETRIES attempts: $*"`

2. In retry_command_output():
   - Remove `local cmd="$1"`
   - Change `output=$(eval "$cmd" 2>/dev/null)` to `output=$("$@" 2>/dev/null)`

3. Update the docstring comments:
   - Change usage from `retry_command <command>` to `retry_command <cmd> [args...]`
   - Change `# Usage: result=$(retry_command_output <command>)` to reflect new syntax

Note: Use `$*` for echo (concatenates with spaces for display) and `"$@"` for execution (preserves argument boundaries).
  </action>
  <verify>TypeScript compiles: `cd /Users/mateo/Projects/dedicated-ec2-k8s-autoscaler && npx tsc --noEmit`</verify>
  <done>retry_command() and retry_command_output() use "$@" pattern instead of eval, docstrings updated</done>
</task>

<task type="auto">
  <name>Task 2: Update all retry_command callers to use argument syntax</name>
  <files>lib/scripts/control-plane-bootstrap.ts, lib/scripts/worker-bootstrap.ts</files>
  <action>
Search and replace all retry_command and retry_command_output calls from string syntax to argument syntax.

Pattern transformation:
- FROM: `retry_command "aws ssm put-parameter --name 'foo' --value 'bar'"`
- TO:   `retry_command aws ssm put-parameter --name 'foo' --value 'bar'`

- FROM: `RESULT=$(retry_command_output "aws ssm get-parameter --name 'foo'")`
- TO:   `RESULT=$(retry_command_output aws ssm get-parameter --name 'foo')`

Apply this transformation to ALL occurrences in:
1. lib/scripts/control-plane-bootstrap.ts (~30 occurrences)
2. lib/scripts/worker-bootstrap.ts (~7 occurrences)

IMPORTANT: Be careful with command substitution in arguments. For example:
- FROM: `retry_command "aws ssm put-parameter --value '\$(date -u)' --region $REGION"`
- TO:   `retry_command aws ssm put-parameter --value "\$(date -u)" --region $REGION`

The escaped `\$` becomes `$` since we're no longer in double quotes that get eval'd.
Similarly, single-quoted arguments like `'value'` should be preserved as single quotes.
  </action>
  <verify>TypeScript compiles: `cd /Users/mateo/Projects/dedicated-ec2-k8s-autoscaler && npx tsc --noEmit`</verify>
  <done>All retry_command and retry_command_output calls use argument syntax instead of string syntax</done>
</task>

<task type="auto">
  <name>Task 3: Run tests to verify behavioral equivalence</name>
  <files>test/*.test.ts</files>
  <action>
Run the full test suite to verify the changes don't break any existing functionality.

The tests verify retry_command behavior by checking the generated bootstrap scripts.
Key test files that verify retry behavior:
- test/cluster-init-lock.test.ts
- test/oidc-setup.test.ts
- test/disaster-recovery.test.ts
- test/token-management.test.ts
- test/control-plane-join.test.ts
- test/nlb-target-management.test.ts
- test/worker-node-bootstrap.test.ts

Run: `npm test`

If any tests fail, analyze the failure and fix. The most likely issue would be
quote handling differences between eval and direct execution.
  </action>
  <verify>`npm test` passes all 30 test files</verify>
  <done>All existing tests pass, confirming behavioral equivalence</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx tsc --noEmit` passes (TypeScript compiles)
- [ ] `npm test` passes all tests
- [ ] No `eval` in retry functions (grep confirms removal)
- [ ] All retry_command calls use argument syntax (no quoted command strings)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- eval removed from bash-retry.ts (0 occurrences)
- ~37 caller sites updated to argument syntax
- All 30 test files pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-eval-removal/05-01-SUMMARY.md`
</output>
