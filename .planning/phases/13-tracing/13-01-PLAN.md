---
phase: 13-tracing
plan: 01
type: execute
---

<objective>
Add correlation ID infrastructure to Python and Bash logging modules.

Purpose: Enable tracing of related operations across Lambda invocations and script execution by providing trace_id fields in all log output.
Output: Updated python-logging.ts and bash-logging.ts with trace ID support.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-structured-logging/09-04-SUMMARY.md

**Key files:**
@lib/scripts/python-logging.ts
@lib/scripts/bash-logging.ts
@test/scripts/python-logging.test.ts
@test/scripts/bash-logging.test.ts

**Tech stack available:** Python logging module, bash functions, JSON output format
**Established patterns:**
- Python: setup_logging(context) returns logger, extra dict for additional fields
- Bash: log_json outputs JSON with key=value pairs, INSTANCE_ID and BOOTSTRAP_STAGE as context variables

**Constraining decisions:**
- Phase 9: Log messages use static strings with context in extra dict
- Phase 9: Lambda uses setup_logging(context) at handler start
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add trace_id support to Python logging module</name>
  <files>lib/scripts/python-logging.ts, test/scripts/python-logging.test.ts</files>
  <action>
Update getPythonLoggingSetup() to support trace_id:
1. Add _trace_id global variable alongside _request_id and _function_name
2. Update JsonFormatter.format() to include trace_id in log_record (after function_name)
3. Update setup_logging() to accept optional trace_id parameter: setup_logging(context=None, trace_id=None)
4. If trace_id not provided, generate one using uuid.uuid4().hex[:16] (16-char hex for shorter IDs)
5. Add uuid import at top of the Python code string
6. Add trace_id to standard_attrs set to prevent duplication

DO NOT use full 32-char UUIDs - 16 chars is sufficient for correlation and keeps logs readable.
DO NOT make trace_id generation mandatory in context - it should work with or without context.

Update test file to verify:
- trace_id appears in log output
- Custom trace_id can be passed to setup_logging
- Auto-generated trace_id is 16 chars hex
  </action>
  <verify>npm run test:code -- --testPathPattern="python-logging" passes</verify>
  <done>Python logging outputs trace_id in all log records, tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Add TRACE_ID support to Bash logging module</name>
  <files>lib/scripts/bash-logging.ts, test/scripts/bash-logging.test.ts</files>
  <action>
Update getBashLoggingFunctions() to support TRACE_ID:
1. Add TRACE_ID to the context variables section (alongside INSTANCE_ID, BOOTSTRAP_STAGE)
2. Update log_json() to include trace_id field if TRACE_ID variable is set
3. Add generate_trace_id() helper function that outputs a 16-char hex ID using /dev/urandom:
   - Use: head -c 8 /dev/urandom | od -An -tx1 | tr -d ' \n'
   - This produces 16 hex chars from 8 random bytes
4. Add init_trace_id() function that sets TRACE_ID if not already set (for bootstrap scripts to call at start)

DO NOT require TRACE_ID to be set - log_json should work without it (graceful fallback).
DO NOT use uuidgen as it may not be available on all systems.

Update test file to verify:
- trace_id appears in log output when TRACE_ID is set
- generate_trace_id produces 16-char hex string
- log_json works without TRACE_ID set (no error)
  </action>
  <verify>npm run test:code -- --testPathPattern="bash-logging" passes</verify>
  <done>Bash logging outputs trace_id when TRACE_ID is set, helper functions exist, tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run test:code -- --testPathPattern="logging" passes (both python-logging and bash-logging)
- [ ] npm run build succeeds without errors
- [ ] Python logging includes trace_id in JSON output
- [ ] Bash logging includes trace_id when TRACE_ID variable is set
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Logging modules support trace_id without breaking existing usage
</success_criteria>

<output>
After completion, create `.planning/phases/13-tracing/13-01-SUMMARY.md`
</output>
