---
phase: 13-tracing
plan: 03
type: execute
---

<objective>
Integrate trace ID generation and logging into bootstrap scripts.

Purpose: Enable correlation of bootstrap operations by generating TRACE_ID at script start and including it in all log messages.
Output: Updated control-plane and worker bootstrap scripts with TRACE_ID support.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-tracing/13-01-SUMMARY.md
@.planning/phases/13-tracing/13-02-SUMMARY.md

**Key files:**
@lib/scripts/control-plane-bootstrap.ts
@lib/scripts/worker-bootstrap.ts
@lib/scripts/bash-logging.ts
@test/compute-stack.test.ts

**Tech stack available:** Bash scripts, getBashLoggingFunctions() with TRACE_ID support
**Established patterns:**
- Bootstrap scripts call getBashLoggingFunctions() to include logging
- INSTANCE_ID and BOOTSTRAP_STAGE set before logging functions used
- log_info, log_error, log_warn used for all logging

**From Plan 13-01:** init_trace_id() function available to generate TRACE_ID if not set
**From Plan 13-02:** SSM commands from Lambda include export TRACE_ID=xxx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update control-plane-bootstrap to generate and log TRACE_ID</name>
  <files>lib/scripts/control-plane-bootstrap.ts, test/compute-stack.test.ts</files>
  <action>
Update createControlPlaneBootstrapScript():

1. After the getBashLoggingFunctions() interpolation and before first log_info call, add:
   - Call init_trace_id to generate TRACE_ID if not already set (SSM commands set it)
   - This handles both standalone bootstrap (generates new ID) and SSM-triggered operations (uses passed ID)

2. The init_trace_id() call should be:
   ```
   # Initialize trace ID for operation correlation
   # If TRACE_ID is already set (from SSM command), use it; otherwise generate new
   init_trace_id
   ```

3. After TRACE_ID is initialized, log it in the first substantive log message:
   - Update the "Instance metadata retrieved" log_info to include trace_id=$TRACE_ID

4. Ensure TRACE_ID is available before any critical operations:
   - Position init_trace_id after INSTANCE_ID is set but before cleanup_on_failure runs

DO NOT change existing log message content - only add trace_id to key messages.
DO NOT add trace_id to every single log message - focus on operation boundaries:
- Bootstrap start
- Major stage transitions (kubeadm init, join, etcd registration)
- Error messages (already have other context)

Update test to verify TRACE_ID initialization appears in script output.
  </action>
  <verify>npm run test:code -- --testPathPattern="compute-stack" passes</verify>
  <done>Control plane bootstrap initializes TRACE_ID and includes it in logs, tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Update worker-bootstrap to generate and log TRACE_ID</name>
  <files>lib/scripts/worker-bootstrap.ts, test/compute-stack.test.ts</files>
  <action>
Update createWorkerBootstrapScript():

1. After the getBashLoggingFunctions() interpolation and before first log_info call, add:
   - Call init_trace_id to generate TRACE_ID if not set
   - Position after INSTANCE_ID is set

2. Add init_trace_id call:
   ```
   # Initialize trace ID for operation correlation
   init_trace_id
   ```

3. Update the "Instance metadata retrieved" log_info to include trace_id=$TRACE_ID

4. Add trace_id to key operation logs:
   - Cluster join start
   - Join success/failure

DO NOT add trace_id to every log message - keep it focused on operation correlation.
DO NOT change the worker bootstrap flow or behavior.

Update test to verify TRACE_ID initialization appears in script output.
  </action>
  <verify>npm run test:code -- --testPathPattern="compute-stack" passes</verify>
  <done>Worker bootstrap initializes TRACE_ID and includes it in logs, tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run test:code passes (full test suite)
- [ ] npm run build succeeds without errors
- [ ] Control plane bootstrap includes init_trace_id call
- [ ] Worker bootstrap includes init_trace_id call
- [ ] Key log messages include trace_id
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Bootstrap scripts generate and log TRACE_ID
- Phase 13 complete
</success_criteria>

<output>
After completion, create `.planning/phases/13-tracing/13-03-SUMMARY.md` with:
- Phase complete confirmation
- All 3 plans summary
- Next steps (v1.1 milestone complete or next work)
</output>
