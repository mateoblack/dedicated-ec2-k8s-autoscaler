---
phase: 13-tracing
plan: 02
type: execute
---

<objective>
Integrate trace IDs into Lambda functions that execute SSM commands.

Purpose: Propagate correlation IDs from Lambda through SSM commands so operations can be traced end-to-end.
Output: Updated Lambda code generators passing trace_id to SSM commands via environment variables.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-tracing/13-01-SUMMARY.md

**Key files:**
@lib/scripts/etcd-lifecycle-lambda.ts
@lib/scripts/etcd-backup-lambda.ts
@lib/scripts/python-logging.ts
@test/before-terminate-lifecycle.test.ts
@test/etcd-backup-lambda.test.ts

**Tech stack available:** Python Lambda, boto3 SSM client, setup_logging with trace_id
**Established patterns:**
- Lambda uses setup_logging(context) at handler start
- SSM commands use ssm.send_command() with Parameters={'commands': [...]}
- Log messages use extra={'key': value} pattern

**From Plan 13-01:** setup_logging(context, trace_id) now generates trace_id if not provided
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update etcd-lifecycle-lambda to pass trace_id in SSM commands</name>
  <files>lib/scripts/etcd-lifecycle-lambda.ts, test/before-terminate-lifecycle.test.ts</files>
  <action>
Update createEtcdLifecycleLambdaCode():

1. Update handler to generate trace_id at start:
   - Change: logger = setup_logging(context)
   - To: trace_id = uuid.uuid4().hex[:16]
         logger = setup_logging(context, trace_id)
   - Add uuid import if not present

2. Store trace_id in a variable accessible to helper functions:
   - Add: _trace_id = None as global (similar to _request_id pattern)
   - Set it at handler start alongside logger setup

3. Update drain_node() SSM command to include trace_id:
   - Add at start of command: export TRACE_ID="{_trace_id}"
   - This makes TRACE_ID available to any scripts on the target instance

4. Update remove_etcd_member() SSM command to include trace_id:
   - Add at start of command: export TRACE_ID="{_trace_id}"

5. Update log messages that reference SSM commands to include trace_id:
   - Add trace_id to extra dict in "SSM drain command sent" and "SSM command sent" logs

DO NOT change the behavior of existing functionality - only add trace_id propagation.
DO NOT use f-strings for the trace_id in shell commands - use proper Python string formatting.

Update tests to verify trace_id appears in generated code.
  </action>
  <verify>npm run test:code -- --testPathPattern="before-terminate-lifecycle" passes</verify>
  <done>etcd-lifecycle Lambda generates trace_id and passes it to SSM commands, tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Update etcd-backup-lambda to pass trace_id in SSM commands</name>
  <files>lib/scripts/etcd-backup-lambda.ts, test/etcd-backup-lambda.test.ts</files>
  <action>
Update createEtcdBackupLambdaCode():

1. Update handler to generate trace_id at start:
   - Change: logger = setup_logging(context)
   - To: trace_id = uuid.uuid4().hex[:16]
         logger = setup_logging(context, trace_id)
   - Add uuid import if not present (it may already be imported by logging setup)

2. Store trace_id in a global variable for use in helper functions:
   - Add: _trace_id = None pattern (after the other globals)
   - Set in handler before logging

3. Update create_etcd_backup() SSM command to include trace_id:
   - Add at start of command: export TRACE_ID="{_trace_id}"
   - This makes TRACE_ID available to the etcdctl backup script

4. Update log message for "SSM backup command sent" to include trace_id in extra dict

DO NOT modify the backup S3 key format - trace_id is for logging correlation only.
DO NOT add trace_id to S3 metadata - keep it simple for now.

Update tests to verify trace_id appears in generated code.
  </action>
  <verify>npm run test:code -- --testPathPattern="etcd-backup" passes</verify>
  <done>etcd-backup Lambda generates trace_id and passes it to SSM commands, tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run test:code -- --testPathPattern="lifecycle|backup" passes
- [ ] npm run build succeeds without errors
- [ ] Lambda code includes trace_id generation at handler start
- [ ] SSM commands include TRACE_ID export
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Lambda functions propagate trace_id through SSM commands
</success_criteria>

<output>
After completion, create `.planning/phases/13-tracing/13-02-SUMMARY.md`
</output>
