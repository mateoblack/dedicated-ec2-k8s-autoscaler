---
phase: 11-error-messages
plan: 01
type: execute
---

<objective>
Improve error messages in Python Lambda functions with actionable context and root cause hints.

Purpose: Make operational issues in etcd lifecycle, backup, and health Lambda functions easier to diagnose and resolve by providing clear error messages with context about what failed, why it might have failed, and what to check.

Output: Updated Lambda code generators with improved exception messages and logger.error calls.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-structured-logging/09-04-SUMMARY.md
@.planning/phases/10-cloudwatch-metrics/10-03-SUMMARY.md

**Key files:**
@lib/scripts/etcd-lifecycle-lambda.ts
@lib/scripts/etcd-backup-lambda.ts
@lib/scripts/cluster-health-lambda.ts

**Established patterns from Phase 9:**
- Lambda structured logging: `logger = setup_logging(context)` at handler start
- Context via extra dict: `logger.info('message', extra={'key': value})`
- Error logging includes `error_type: type(e).__name__`

**Custom exceptions defined:**
- `NodeDrainError(message, is_retriable=True)` - node drain failures
- `EtcdRemovalError(message, is_retriable=True)` - etcd member removal failures
- `QuorumRiskError(message)` - quorum safety violations
- `BackupError(message, is_retriable=True)` - backup operation failures

**Current error message issues:**
1. Generic messages like "No healthy control plane instances available" lack context about WHY
2. Exception messages don't include what to check or troubleshoot
3. Timeout errors don't explain what operation timed out and why that matters
4. logger.error calls often just log `str(e)` without actionable guidance
</context>

<tasks>

<task type="auto">
  <name>Task 1: Improve etcd-lifecycle-lambda error messages</name>
  <files>lib/scripts/etcd-lifecycle-lambda.ts</files>
  <action>
Update error messages in etcd-lifecycle-lambda.ts to include actionable context:

1. **QuorumRiskError** (line ~270): Add guidance about what to check
   - Current: "Only {healthy_count} healthy nodes remaining. Need at least {MIN_HEALTHY_NODES_FOR_REMOVAL} to safely remove a member."
   - Improved: Include check suggestions (verify ASG health, check EC2 console, review CloudWatch metrics)

2. **NodeDrainError** exceptions:
   - "No healthy control plane instances available for drain" → Add "Check ASG status in EC2 console. Verify instances are InService and passing health checks."
   - "SSM drain command timed out" → Add context about DRAIN_TIMEOUT and what might cause slow drains
   - "kubectl drain failed" → Include common causes (PodDisruptionBudgets, stuck pods)

3. **EtcdRemovalError** exceptions:
   - "No healthy control plane instances available" → Add ASG/EC2 check guidance
   - "SSM command timed out" → Add timeout context and common causes
   - "etcdctl failed" → Include common etcd issues (network, certificates)

4. **logger.error calls**: Enhance with troubleshooting guidance in extra dict:
   - Add `check` field with what to verify
   - Add `possible_causes` field for common failure reasons

Keep messages concise but actionable. Format: "[What failed]. [Root cause hints]. [What to check]."
  </action>
  <verify>npm run test:code passes</verify>
  <done>All NodeDrainError, EtcdRemovalError, QuorumRiskError exceptions have actionable messages. logger.error calls include troubleshooting context.</done>
</task>

<task type="auto">
  <name>Task 2: Improve etcd-backup-lambda error messages</name>
  <files>lib/scripts/etcd-backup-lambda.ts</files>
  <action>
Update error messages in etcd-backup-lambda.ts to include actionable context:

1. **BackupError** exceptions:
   - "Failed to send SSM command" → Add SSM agent check guidance
   - "SSM backup command timed out" → Add context about what's taking time (etcd snapshot, S3 upload)
   - "Backup command succeeded but no success marker found" → Explain what success marker is and why it might be missing
   - "Backup command failed" → Include common causes (disk space, etcd health, S3 permissions)

2. **logger.error calls**:
   - "No healthy control plane instances found for backup" → Add "Check ASG health in EC2 console"
   - "Backup failed" → Include guidance on checking etcd health and S3 bucket permissions
   - Environment variable errors → Add where to configure them (CDK stack)

3. **Inline script errors** (echo "ERROR:..."):
   - "etcd is not healthy" → Add what to check (etcd endpoint status, certificates)
   - "Snapshot integrity check failed" → Add what this means and recovery steps

Format: "[What failed]. [Root cause hints]. [What to check]."
  </action>
  <verify>npm run test:code passes</verify>
  <done>All BackupError exceptions have actionable messages. logger.error and inline script errors include troubleshooting context.</done>
</task>

<task type="auto">
  <name>Task 3: Improve cluster-health-lambda error messages</name>
  <files>lib/scripts/cluster-health-lambda.ts</files>
  <action>
Update error messages in cluster-health-lambda.ts to include actionable context:

1. **logger.error calls**:
   - "TRIGGERING AUTO-RECOVERY" → Add context about what this means and what happens next
   - "No backup available for restore" → Add guidance on checking S3 bucket and backup schedule
   - "Health check error" → Add common causes (network, IAM permissions)
   - "Error getting instance count" → Add ASG API troubleshooting
   - "Error getting/setting failure count" → Add DynamoDB access check
   - "Error listing backups" → Add S3 bucket permission check
   - "Error triggering restore mode" → Add SSM parameter check
   - "Error clearing restore mode" → Add SSM parameter check

2. **Add structured troubleshooting context**:
   - Use extra dict with `check`, `possible_causes` fields
   - Include relevant resource names (bucket, table, ASG) in error context

Format: "[What failed]. [Root cause hints]. [What to check]."
  </action>
  <verify>npm run test:code passes</verify>
  <done>All logger.error calls in cluster-health-lambda include actionable troubleshooting context.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:code` passes without errors
- [ ] Error messages include what failed, why it might fail, and what to check
- [ ] No hardcoded resource names in error messages (use variables)
- [ ] Existing structured logging pattern preserved (extra dict)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Error messages are actionable (each explains what to check)
- No regressions in test coverage
</success_criteria>

<output>
After completion, create `.planning/phases/11-error-messages/11-01-SUMMARY.md` following the summary template.
</output>
