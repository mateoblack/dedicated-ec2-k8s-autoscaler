---
phase: 11-error-messages
plan: 02
type: execute
---

<objective>
Improve error messages in Bash bootstrap scripts with actionable context and root cause hints.

Purpose: Make bootstrap failures easier to diagnose by providing clear error messages that explain what failed, common root causes, and what operators should check to resolve the issue.

Output: Updated bootstrap script generators with improved log_error calls.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-structured-logging/09-02-SUMMARY.md
@.planning/phases/10-cloudwatch-metrics/10-04-SUMMARY.md
@.planning/phases/11-error-messages/11-01-SUMMARY.md

**Key files:**
@lib/scripts/control-plane-bootstrap.ts
@lib/scripts/worker-bootstrap.ts
@lib/scripts/bash-retry.ts

**Established patterns from Phase 9:**
- Bash structured logging: `log_error "message" "key=value"...`
- JSON output with level, timestamp, message, and context fields
- Context passed as key=value pairs after the message

**Current error message issues:**
1. Short messages like "Failed to get instance metadata" lack troubleshooting guidance
2. SSM parameter errors don't explain where values come from
3. Timeout errors don't explain what was being waited for
4. etcd/kubeadm errors don't point to logs or common fixes
</context>

<tasks>

<task type="auto">
  <name>Task 1: Improve control-plane-bootstrap error messages</name>
  <files>lib/scripts/control-plane-bootstrap.ts</files>
  <action>
Update log_error calls in control-plane-bootstrap.ts to include actionable context.

**Instance/Metadata errors:**
- "Failed to get instance metadata" → Add "Check IMDS availability. Verify IMDSv2 is configured correctly. Check instance IAM role."

**etcd errors:**
- "etcd did not become healthy in time" → Add "Check etcd logs: journalctl -u etcd. Verify certificates in /etc/kubernetes/pki/etcd/. Check if port 2379 is accessible."
- "Failed to get etcd member list" → Add "Verify etcd endpoint health. Check certificate permissions."
- "Could not determine etcd member ID" → Add "etcd member may not be fully registered. Check etcd member list output."
- "Failed to register etcd member in DynamoDB" → Add "Check IAM role permissions for DynamoDB PutItem on {table}."

**Backup/Restore errors:**
- "Failed to download backup from S3" → Add "Check S3 bucket permissions and backup file existence."
- "etcd restore failed" → Add "Check etcd data directory permissions. Verify backup file integrity."

**kubeadm errors:**
- "kubeadm init after restore failed" → Add "Check kubeadm logs: journalctl -xeu kubelet. Verify all required ports are available."
- "Cluster initialization failed" → Add "Check kubeadm output above. Common issues: port conflicts, certificate errors."
- "Disaster recovery failed" → Add "Check etcd restore status. Verify backup integrity."

**SSM parameter errors:**
- "Failed to store X in SSM" → Add "Check IAM role permissions for SSM PutParameter."
- "Cluster endpoint not initialized" → Add "First control plane may not have completed initialization. Check other control plane instance logs."
- "SSM parameters contain uninitialized values" → Add "Wait for cluster initialization to complete. Check first control plane bootstrap logs."
- "Cannot join cluster - SSM parameters not ready" → Add "First control plane must complete kubeadm init. Check /var/log/cloud-init-output.log on first node."

**Join errors:**
- "Join failed even with fresh token" → Add "Check kubeadm join output. Verify network connectivity to API server."
- "Could not get a new token" → Add "No healthy control plane instances found. Check ASG health."
- "Token refresh failed" → Add "SSM command failed. Check target instance SSM agent."
- "Missing join information" → Add "Cluster may not be initialized. Check SSM parameters."

**NLB/OIDC errors:**
- "Modulus extraction failed" → Add "OpenSSL operation failed. Check SA key file permissions."
- "Generated keys.json has invalid JWK structure" → Add "Key generation failed. Check OpenSSL version and jq availability."

Format: Add troubleshooting context as additional key=value parameters:
`log_error "Main message" "check=What to verify" "common_causes=List of causes"`
  </action>
  <verify>npm run test:code passes</verify>
  <done>All log_error calls in control-plane-bootstrap.ts include actionable troubleshooting context with check and common_causes fields.</done>
</task>

<task type="auto">
  <name>Task 2: Improve worker-bootstrap error messages</name>
  <files>lib/scripts/worker-bootstrap.ts</files>
  <action>
Update log_error calls in worker-bootstrap.ts to include actionable context.

**Instance/Metadata errors:**
- "Failed to get instance metadata" → Add "Check IMDS availability. Verify IMDSv2 is configured correctly."

**SSM/Cluster readiness errors:**
- "Timeout waiting for cluster initialization" → Add "Cluster initialization takes 5-10 minutes. Check control plane bootstrap logs."
- "No healthy control plane instance found" → Add "Check control plane ASG health. Verify instances are InService."
- "Failed to send SSM command" → Add "Check SSM agent on target instance. Verify IAM permissions."
- "SSM command failed" → Add "Check SSM Run Command history in AWS console."
- "Token refresh command did not succeed" → Add "Control plane may be unhealthy. Check target instance logs."
- "Timeout waiting for token refresh" → Add "Control plane may be overloaded. Check kubeadm token create output."

**Parameter validation errors:**
- "Cluster endpoint not initialized - cluster may not be ready" → Add "Wait for control plane initialization. Check SSM parameter store."
- "CA certificate hash not initialized" → Add "Control plane must complete initialization first."
- "Join token not initialized" → Add "Control plane must generate join token first."
- "SSM parameters contain uninitialized values" → Add "First control plane may be initializing. Check /var/log/cloud-init-output.log."

**Join errors:**
- "Join failed even with fresh token" → Add "Check kubeadm join output above. Verify network to API server endpoint."
- "Could not get a different token" → Add "Token refresh returned same token. Control plane may be unhealthy."
- "Token refresh failed" → Add "SSM command to control plane failed. Check control plane health."
- "Missing required join parameters from SSM" → Add "Cluster may not be initialized. Check control plane logs."

Format: Add troubleshooting context as additional key=value parameters:
`log_error "Main message" "check=What to verify" "common_causes=List of causes"`
  </action>
  <verify>npm run test:code passes</verify>
  <done>All log_error calls in worker-bootstrap.ts include actionable troubleshooting context.</done>
</task>

<task type="auto">
  <name>Task 3: Improve bash-retry error messages</name>
  <files>lib/scripts/bash-retry.ts</files>
  <action>
Update error messages in bash-retry.ts to include context about what was being retried.

**retry_command failure:**
- "Command failed after all retries" → Add "Check command output above. Verify prerequisites for the operation."

**retry_command_output failure:**
- Similar improvement with context about output capture

The retry functions already log the command being run. Ensure the final failure message includes:
1. The number of attempts made
2. Guidance to check the preceding logs for the actual error
3. Common causes for retry exhaustion (transient vs persistent failures)

Format: Use existing conditional logging pattern:
```bash
if command -v log_error >/dev/null 2>&1; then
    log_error "Command failed after all retries" "attempts=$MAX_RETRIES" "command=$*" "check=Review command output above" "hint=If error is consistent, issue may be persistent not transient"
else
    echo "ERROR: Command failed after $MAX_RETRIES attempts: $*. Check output above for error details."
fi
```
  </action>
  <verify>npm run test:code passes</verify>
  <done>bash-retry.ts error messages include context about retry exhaustion and troubleshooting guidance.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:code` passes without errors
- [ ] All log_error calls include check= or common_causes= context
- [ ] No hardcoded resource names (use variables from context)
- [ ] Messages follow format: "[What failed]. [Context parameters]"
- [ ] Existing shellcheck compliance maintained
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Bash error messages are actionable (each explains what to check)
- Phase 11 complete
</success_criteria>

<output>
After completion, create `.planning/phases/11-error-messages/11-02-SUMMARY.md` following the summary template.
</output>
