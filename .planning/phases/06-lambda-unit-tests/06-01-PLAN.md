---
phase: 06-lambda-unit-tests
plan: 01
type: execute
---

<objective>
Add unit tests for the 3 Lambda code generator functions (createEtcdLifecycleLambdaCode, createEtcdBackupLambdaCode, createClusterHealthLambdaCode).

Purpose: Validate that Lambda code generators produce correct Python code with proper parameter interpolation, expected handler functions, error classes, and retry patterns.
Output: New test file `test/lambda-code-generators.test.ts` with comprehensive tests for all 3 Lambda generators.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Source files under test
@lib/scripts/etcd-lifecycle-lambda.ts
@lib/scripts/etcd-backup-lambda.ts
@lib/scripts/cluster-health-lambda.ts
@lib/scripts/python-retry.ts

# Testing patterns reference
@.planning/codebase/TESTING.md

# Example existing test
@test/etcd-lifecycle-management.test.ts

**Tech stack:** Jest 29.5.0 with ts-jest, existing test patterns in test/
**Established patterns:** `describe()` blocks, `test()` functions, no `beforeAll()` needed (no stack synthesis)
**Constraining decisions:** None - these are new unit tests for extracted functions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Lambda code generator test file</name>
  <files>test/lambda-code-generators.test.ts</files>
  <action>
Create new test file testing all 3 Lambda code generators:

**For each generator (createEtcdLifecycleLambdaCode, createEtcdBackupLambdaCode, createClusterHealthLambdaCode), test:**

1. **Parameter interpolation:**
   - Call function with test values (e.g., clusterName: 'test-cluster')
   - Verify cluster name appears in correct locations in output
   - Verify other params (backupBucket, etc.) interpolated correctly

2. **Python structure validation:**
   - Contains `def handler(event, context):` function
   - Contains expected imports (boto3, json, logging, os)
   - Contains expected AWS client initializations (ec2, ssm, etc.)

3. **Error classes (where applicable):**
   - etcd-lifecycle: NodeDrainError, EtcdRemovalError, QuorumRiskError
   - etcd-backup: BackupError
   - cluster-health: no custom exceptions

4. **Retry utility inclusion:**
   - etcd-lifecycle and etcd-backup include `retry_with_backoff` function
   - cluster-health does NOT use retry utility

5. **Environment variable references:**
   - etcd-lifecycle: CLUSTER_NAME used
   - etcd-backup: CLUSTER_NAME, CONTROL_PLANE_ASG_NAME used
   - cluster-health: CLUSTER_NAME, REGION, CONTROL_PLANE_ASG_NAME, UNHEALTHY_THRESHOLD used

**Test structure:**
```typescript
import { createEtcdLifecycleLambdaCode } from '../lib/scripts/etcd-lifecycle-lambda';
import { createEtcdBackupLambdaCode } from '../lib/scripts/etcd-backup-lambda';
import { createClusterHealthLambdaCode } from '../lib/scripts/cluster-health-lambda';

describe('Lambda Code Generators', () => {
  describe('createEtcdLifecycleLambdaCode', () => {
    // tests...
  });
  describe('createEtcdBackupLambdaCode', () => {
    // tests...
  });
  describe('createClusterHealthLambdaCode', () => {
    // tests...
  });
});
```

**DO NOT:**
- Try to execute the Python code (Jest can't run Python)
- Add excessive pattern matching (test structure, not every line)
- Use snapshot testing (explicit assertions preferred per TESTING.md)
  </action>
  <verify>npm run test:code -- test/lambda-code-generators.test.ts passes</verify>
  <done>Test file exists with passing tests for all 3 Lambda generators covering parameter interpolation, Python structure, error classes, and retry patterns</done>
</task>

<task type="auto">
  <name>Task 2: Verify full test suite still passes</name>
  <files>None (verification only)</files>
  <action>
Run the full test suite to ensure:
1. New tests integrate correctly with existing test infrastructure
2. No regressions in existing 30 test files
3. All tests pass

```bash
npm test
```

If any failures occur, fix them before proceeding.
  </action>
  <verify>npm test exits 0 with all tests passing</verify>
  <done>Full test suite (31 test files now) passes with 0 failures</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:code -- test/lambda-code-generators.test.ts` passes
- [ ] All tests validate expected patterns in generated code
- [ ] `npm test` passes with all existing tests + new tests
- [ ] No TypeScript errors
</verification>

<success_criteria>

- test/lambda-code-generators.test.ts exists and passes
- Tests cover all 3 Lambda code generators
- Tests validate parameter interpolation
- Tests validate Python structure (handler, imports, clients)
- Tests validate error classes where applicable
- Tests validate retry utility inclusion where applicable
- Full test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/06-lambda-unit-tests/06-01-SUMMARY.md`
</output>
