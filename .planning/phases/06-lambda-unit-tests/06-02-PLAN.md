---
phase: 06-lambda-unit-tests
plan: 02
type: execute
---

<objective>
Add unit tests for the 2 bootstrap script generator functions (createWorkerBootstrapScript, createControlPlaneBootstrapScript).

Purpose: Validate that bootstrap script generators produce correct Bash code with proper parameter interpolation, expected function structure, and required patterns.
Output: New test file `test/bootstrap-script-generators.test.ts` with comprehensive tests for both bootstrap generators.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase
@.planning/phases/06-lambda-unit-tests/06-01-SUMMARY.md

# Source files under test
@lib/scripts/worker-bootstrap.ts
@lib/scripts/control-plane-bootstrap.ts
@lib/scripts/bash-retry.ts

# Testing patterns reference
@.planning/codebase/TESTING.md

**Tech stack:** Jest 29.5.0 with ts-jest, existing test patterns in test/
**Established patterns:** `describe()` blocks, `test()` functions
**Constraining decisions:** Bootstrap functions require `cdk.Stack` parameter for region access (01-02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bootstrap script generator test file</name>
  <files>test/bootstrap-script-generators.test.ts</files>
  <action>
Create new test file testing both bootstrap script generators:

**Test setup:**
Need to create a minimal CDK stack for testing (functions require stack for region access):
```typescript
import * as cdk from 'aws-cdk-lib';

// Create minimal stack for testing
const app = new cdk.App();
const stack = new cdk.Stack(app, 'TestStack', {
  env: { account: '123456789012', region: 'us-west-2' }
});
```

**For createWorkerBootstrapScript, test:**

1. **Parameter interpolation:**
   - clusterName appears in output
   - Region (us-west-2) appears in output

2. **Bash structure validation:**
   - Script starts with `#!/bin/bash`
   - Contains `set -e` or error handling
   - Contains expected function definitions (e.g., retry functions)
   - Contains kubeadm join logic

3. **Required patterns:**
   - SSM parameter reads for cluster endpoint
   - Worker node configuration
   - kubelet setup

**For createControlPlaneBootstrapScript, test:**

1. **Parameter interpolation:**
   - clusterName appears in output
   - oidcProviderArn appears in output
   - oidcBucketName appears in output
   - etcdBackupBucketName appears in output
   - Region appears in output

2. **Bash structure validation:**
   - Script starts with `#!/bin/bash`
   - Contains error handling
   - Contains retry functions from bash-retry module
   - Contains kubeadm init and join logic

3. **Required patterns:**
   - DynamoDB bootstrap lock logic
   - etcd member registration
   - SSM parameter writes for cluster endpoint
   - Certificate handling

4. **Retry utility inclusion:**
   - Contains retry_command function (from bash-retry module)
   - Uses "$@" pattern for command execution (per 05-01 eval removal)

**Test structure:**
```typescript
import * as cdk from 'aws-cdk-lib';
import { createWorkerBootstrapScript } from '../lib/scripts/worker-bootstrap';
import { createControlPlaneBootstrapScript } from '../lib/scripts/control-plane-bootstrap';

describe('Bootstrap Script Generators', () => {
  let stack: cdk.Stack;

  beforeAll(() => {
    const app = new cdk.App();
    stack = new cdk.Stack(app, 'TestStack', {
      env: { account: '123456789012', region: 'us-west-2' }
    });
  });

  describe('createWorkerBootstrapScript', () => {
    // tests...
  });

  describe('createControlPlaneBootstrapScript', () => {
    // tests...
  });
});
```

**DO NOT:**
- Try to execute the Bash code
- Add excessive pattern matching (test structure, not every line)
- Use snapshot testing
  </action>
  <verify>npm run test:code -- test/bootstrap-script-generators.test.ts passes</verify>
  <done>Test file exists with passing tests for both bootstrap generators covering parameter interpolation, Bash structure, required patterns, and retry utilities</done>
</task>

<task type="auto">
  <name>Task 2: Verify full test suite passes</name>
  <files>None (verification only)</files>
  <action>
Run the full test suite to ensure:
1. New tests integrate correctly with existing test infrastructure
2. No regressions in existing tests
3. All tests pass

```bash
npm test
```

If any failures occur, fix them before proceeding.
  </action>
  <verify>npm test exits 0 with all tests passing</verify>
  <done>Full test suite (32 test files now) passes with 0 failures</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:code -- test/bootstrap-script-generators.test.ts` passes
- [ ] All tests validate expected patterns in generated code
- [ ] `npm test` passes with all existing tests + new tests
- [ ] No TypeScript errors
</verification>

<success_criteria>

- test/bootstrap-script-generators.test.ts exists and passes
- Tests cover both bootstrap script generators
- Tests validate parameter interpolation
- Tests validate Bash structure (shebang, error handling, functions)
- Tests validate required patterns (kubeadm, SSM, DynamoDB, etcd)
- Tests validate retry utility inclusion
- Full test suite passes
- Phase 6 complete
</success_criteria>

<output>
After completion, create `.planning/phases/06-lambda-unit-tests/06-02-SUMMARY.md`
</output>
