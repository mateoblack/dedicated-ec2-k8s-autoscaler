---
phase: 12-graceful-recovery
plan: 01
type: execute
---

<objective>
Add jitter to bash retry functions to prevent thundering herd when multiple EC2 instances retry simultaneously.

Purpose: When control plane or worker nodes boot concurrently, they all hit AWS APIs (SSM, DynamoDB, S3) at similar times. Without jitter, retries synchronize and create API throttling cascades.
Output: Enhanced bash retry functions with configurable jitter, all bootstrap scripts benefiting automatically.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context:
@.planning/phases/11-error-messages/11-02-SUMMARY.md

# Key files:
@lib/scripts/bash-retry.ts
@lib/scripts/control-plane-bootstrap.ts
@lib/scripts/worker-bootstrap.ts

**Tech stack available:** TypeScript, Bash, Jest
**Established patterns:** Exponential backoff with MAX_RETRIES and RETRY_DELAY variables
**Constraining decisions:**
- Phase 2: Consolidated retry logic into shared bash-retry.ts module
- Phase 11: Error messages enhanced with troubleshooting context
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add jitter to retry_command function</name>
  <files>lib/scripts/bash-retry.ts</files>
  <action>
Add jitter to the exponential backoff calculation in retry_command().

Jitter formula: `actual_delay = delay + random(0, delay * JITTER_FACTOR)`
Where JITTER_FACTOR defaults to 0.3 (30% jitter).

Implementation:
1. Add JITTER_FACTOR variable documentation (default 0.3 if not set)
2. Generate random jitter using `$RANDOM % (delay * 30 / 100)` (bash approximation)
3. Apply jitter to the sleep delay
4. Log the actual delay including jitter in structured logging

Note: Use $RANDOM which is built into bash (0-32767 range). Calculate jitter_max = delay * 30 / 100, then jitter = RANDOM % (jitter_max + 1).
  </action>
  <verify>Run `npm run test:code` to ensure tests pass. Grep for "JITTER" in bash-retry.ts to confirm implementation.</verify>
  <done>retry_command() includes jitter calculation, JITTER_FACTOR documented in comments, structured logging shows actual delay</done>
</task>

<task type="auto">
  <name>Task 2: Add jitter to retry_command_output function</name>
  <files>lib/scripts/bash-retry.ts</files>
  <action>
Apply the same jitter pattern to retry_command_output() function.

Use identical jitter formula: `actual_delay = delay + random(0, delay * JITTER_FACTOR)`

This function is simpler (no logging during retries) so just add jitter to the sleep calculation. Keep it consistent with retry_command().
  </action>
  <verify>Run `npm run test:code` to ensure tests pass. Both retry functions should have jitter.</verify>
  <done>retry_command_output() includes jitter calculation consistent with retry_command()</done>
</task>

<task type="auto">
  <name>Task 3: Update bash-retry tests for jitter</name>
  <files>test/scripts/bash-retry.test.ts</files>
  <action>
Add tests verifying jitter implementation:
1. Test that JITTER_FACTOR is documented in function comments
2. Test that jitter calculation uses RANDOM
3. Test that both retry functions include jitter logic

Note: We test the generated bash string contains the jitter patterns, not runtime behavior.
  </action>
  <verify>Run `npm run test:code -- bash-retry` to verify new tests pass</verify>
  <done>Tests verify jitter is implemented in both retry functions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:code` passes all tests
- [ ] Both retry_command and retry_command_output have jitter
- [ ] Jitter formula documented in comments
- [ ] No TypeScript errors
</verification>

<success_criteria>

- Bash retry functions include jitter to prevent thundering herd
- JITTER_FACTOR (default 0.3) documented for customization
- Tests verify jitter implementation
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/12-graceful-recovery/12-01-SUMMARY.md`
</output>
