---
phase: 12-graceful-recovery
plan: 02
type: execute
---

<objective>
Add per-operation timeout support to bash retry functions to prevent indefinite waiting.

Purpose: Some AWS API calls or kubectl commands can hang indefinitely (network issues, service outages). Without timeout, bootstrap scripts stall and never complete, leaving the instance in an undefined state.
Output: New retry_command_timeout() function with configurable per-call timeout, preserving retry logic.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase:
@.planning/phases/12-graceful-recovery/12-01-PLAN.md

# Key files:
@lib/scripts/bash-retry.ts

**Tech stack available:** TypeScript, Bash, Jest
**Established patterns:** retry_command with exponential backoff and jitter (from 12-01)
**Constraining decisions:**
- Phase 12-01: Added jitter to retry functions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create retry_command_timeout function</name>
  <files>lib/scripts/bash-retry.ts</files>
  <action>
Add new retry_command_timeout() function that wraps commands with timeout.

Signature: `retry_command_timeout <timeout_seconds> <cmd> [args...]`

Implementation:
1. First argument is timeout in seconds
2. Use `timeout` command (GNU coreutils, available on Amazon Linux 2)
3. Wrap the actual command execution: `timeout $timeout_seconds "$@"`
4. Handle timeout exit code (124) as retriable failure
5. Include jitter (consistent with retry_command from 12-01)
6. Log timeout failures distinctly from command failures

Exit codes:
- timeout returns 124 when command times out
- timeout returns 137 (128+9) if command was killed by SIGKILL
- Pass through actual command exit code otherwise

Include structured logging showing timeout value and whether timeout occurred.
  </action>
  <verify>Grep for "retry_command_timeout" in bash-retry.ts. Check function handles exit code 124.</verify>
  <done>retry_command_timeout function exists with timeout handling and jitter</done>
</task>

<task type="auto">
  <name>Task 2: Add retry_command_output_timeout variant</name>
  <files>lib/scripts/bash-retry.ts</files>
  <action>
Add retry_command_output_timeout() for commands that need output capture with timeout.

Signature: `result=$(retry_command_output_timeout <timeout_seconds> <cmd> [args...])`

Implementation mirrors retry_command_timeout but captures stdout. Handle timeout the same way (exit 124 triggers retry).
  </action>
  <verify>Grep for "retry_command_output_timeout" in bash-retry.ts</verify>
  <done>retry_command_output_timeout function exists</done>
</task>

<task type="auto">
  <name>Task 3: Add timeout function tests</name>
  <files>test/scripts/bash-retry.test.ts</files>
  <action>
Add tests for the new timeout functions:
1. Test retry_command_timeout is defined in generated bash
2. Test retry_command_output_timeout is defined
3. Test timeout value is first argument
4. Test exit code 124 handling documented/present
5. Test jitter is included (consistent with 12-01)

Test the generated bash string structure, not runtime behavior.
  </action>
  <verify>Run `npm run test:code -- bash-retry` to verify new tests pass</verify>
  <done>Tests verify both timeout functions are properly generated</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:code` passes all tests
- [ ] retry_command_timeout function handles timeout exit codes
- [ ] retry_command_output_timeout function captures output with timeout
- [ ] Both new functions include jitter
- [ ] No TypeScript errors
</verification>

<success_criteria>

- Two new timeout-aware retry functions available
- Timeout exit code (124) handled as retriable
- Jitter included for consistency
- Tests verify implementation
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/12-graceful-recovery/12-02-SUMMARY.md`
</output>
