---
phase: 04-race-condition-fix
plan: 01
type: execute
---

<objective>
Fix etcd member registration tracking bug in restore_from_backup() function.

Purpose: Ensure cleanup_on_failure() properly deregisters etcd members when bootstrap fails after restore.
Output: Fixed control-plane-bootstrap.ts with consistent ETCD_REGISTERED tracking across all code paths.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-variable-scoping-fix/03-01-SUMMARY.md

# Key file:
@lib/scripts/control-plane-bootstrap.ts

**Prior decisions:**
- Phase 03-01: Process substitution pattern `< <(cmd)` for parent shell variable reads

**Tech available:**
- Bash bootstrap scripts extracted to lib/scripts/
- Shared retry module (bash-retry.ts)

**Established patterns:**
- `if function_name; then FLAG=true else WARNING fi` pattern for setting state flags

**Bug analysis:**

The CONCERNS.md described: "etcd member registration race condition where ETCD_REGISTERED=true is set before DynamoDB confirmation completes"

Upon investigation, this is **already fixed** in most code paths:
- Lines 770-774: `if register_etcd_member; then ETCD_REGISTERED=true` (correct)
- Lines 1538-1542: `if register_etcd_member; then ETCD_REGISTERED=true` (correct)
- Lines 1580-1584: `if register_etcd_member; then ETCD_REGISTERED=true` (correct)

However, **one code path is inconsistent**:
- Line 460 (inside restore_from_backup()): `register_etcd_member || echo "WARNING: ..."`
  - This does NOT set `ETCD_REGISTERED=true` on success
  - If something fails after this point during restore, cleanup_on_failure() at line 65 checks `if [ "$ETCD_REGISTERED" = "true" ]` and won't clean up

**Impact:** During disaster recovery via restore_from_backup(), if anything fails after etcd member registration (e.g., CNI install), the etcd member entry remains orphaned in DynamoDB because ETCD_REGISTERED is never set to true.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix ETCD_REGISTERED tracking in restore_from_backup()</name>
  <files>lib/scripts/control-plane-bootstrap.ts</files>
  <action>
Replace line 460:
```bash
register_etcd_member || echo "WARNING: Failed to register etcd member"
```

With the consistent pattern used elsewhere:
```bash
if register_etcd_member; then
    ETCD_REGISTERED=true
else
    echo "WARNING: Failed to register etcd member, lifecycle cleanup may not work"
fi
```

This matches the pattern at lines 770-774, 1538-1542, and 1580-1584.
  </action>
  <verify>grep -A3 "Register etcd member" lib/scripts/control-plane-bootstrap.ts shows the if/then pattern at line 460</verify>
  <done>restore_from_backup() function sets ETCD_REGISTERED=true on successful registration</done>
</task>

<task type="auto">
  <name>Task 2: Verify tests pass</name>
  <files>N/A (verification only)</files>
  <action>
Run the test suite to ensure no regressions:
```bash
npm run test:code
```

All 901 tests should continue to pass. No new tests needed - this is a bug fix that aligns existing behavior, not a new feature.
  </action>
  <verify>npm run test:code exits with 0, output shows all tests passing</verify>
  <done>All existing tests pass without modification</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Line 460 in restore_from_backup() now uses if/then pattern
- [ ] ETCD_REGISTERED=true is set on successful registration
- [ ] All 901 tests pass
- [ ] Pattern matches other call sites (lines 770, 1538, 1580)
</verification>

<success_criteria>

- ETCD_REGISTERED tracking is consistent across all code paths
- restore_from_backup() properly sets the flag for cleanup_on_failure() to use
- All tests pass
- Phase 4 complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-race-condition-fix/04-01-SUMMARY.md` with:
- Frontmatter with dependency graph
- Bug description and fix
- Files modified
- Test results
- Commit hashes
</output>
