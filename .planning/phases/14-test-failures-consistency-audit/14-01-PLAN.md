---
phase: 14-test-failures-consistency-audit
plan: 01
type: execute
---

<objective>
Fix the 3 failing test assertions and ensure all tests pass.

Purpose: Resolve known test failures blocking CI/CD and validate codebase quality.
Output: All 1,287 tests passing with zero failures.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Identified failures from `npm run test:code`:**

1. `test/lambda-code-generators.test.ts:43` - Tests for `logger = setup_logging(context)` but actual code uses `logger = setup_logging(context, trace_id)` after v1.1 tracing additions

2. `test/lambda-code-generators.test.ts:165` - Same issue for etcd-backup-lambda

3. `test/token-management.test.ts:160` - Tests for "No other healthy control plane instance found" but actual message is "No healthy control plane instance found"

**Root cause:** v1.1 tracing phase (Phase 13) updated Lambda code to include trace_id parameter, and structured logging changed some error message wording. Tests were not updated to match.

@test/lambda-code-generators.test.ts
@test/token-management.test.ts
@lib/scripts/python-logging.ts
@lib/scripts/control-plane-bootstrap.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Lambda logging test assertions</name>
  <files>test/lambda-code-generators.test.ts</files>
  <action>
Update the two failing test assertions in lambda-code-generators.test.ts:

1. Line 43: Change `expect(code).toContain('logger = setup_logging(context)')` to `expect(code).toContain('logger = setup_logging(context')` - use partial match since trace_id may or may not be present

2. Line 165: Same fix for the etcd-backup-lambda test

WHY partial match: The logging setup signature is `setup_logging(context, trace_id=None)` where trace_id is optional. Tests should verify the pattern exists without being overly strict about the exact signature.
  </action>
  <verify>npm run test:code -- test/lambda-code-generators.test.ts 2>&1 | grep -E "passed|failed"</verify>
  <done>Both "configures structured logging" tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Fix token management error message assertion</name>
  <files>test/token-management.test.ts</files>
  <action>
Update the failing assertion at line 160:

Change `expect(controlPlaneUserData).toContain('No other healthy control plane instance found')`
to `expect(controlPlaneUserData).toContain('No healthy control plane instance found')`

WHY: The actual log message in control-plane-bootstrap.ts:1237 uses "No healthy control plane instance found" without "other". The structured logging format with log_error already provides context about what operation failed.
  </action>
  <verify>npm run test:code -- test/token-management.test.ts 2>&1 | grep -E "passed|failed"</verify>
  <done>token-management.test.ts passes all 93 tests</done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite and verify zero failures</name>
  <files>-</files>
  <action>
Run the full test suite to confirm all failures are fixed:

1. Run `npm run test:code`
2. Verify output shows "Tests: X passed, X total" with no failures
3. Document the final test count
  </action>
  <verify>npm run test:code 2>&1 | tail -5</verify>
  <done>Test output shows "Tests: 0 failed, 1287 passed, 1287 total" (or similar - all passing)</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:code` passes with 0 failures
- [ ] All 3 previously failing tests now pass
- [ ] No new test failures introduced
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Test suite shows 0 failures
- Previously failing tests (lambda-code-generators, token-management) all pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-test-failures-consistency-audit/14-01-SUMMARY.md`
</output>
